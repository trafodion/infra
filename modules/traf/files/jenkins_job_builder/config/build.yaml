- job-group:
    name: 'builds'
    flavor:
      - "release"
      - "debug"
    branch:
      - "master"

    jobs:
      - build-{branch}-{flavor}

- job-template:
    name: 'build-{branch}-{flavor}'
    node: 'traf_bld'

    parameters:
      - string:
          name: LOG_PATH
      - string:
          name: BUILD_TYPE
          default: ""
          description: "Blank for manual build; check, daily, pre-release, release"

    builders:
      - link-logs
      - clean-buildspace
      - single-git-stable:
           repos: "apache/incubator-trafodion"
           branch: "{branch}"
      - pkg-traf:
           flavor: "{flavor}"
      - check-build:
           dir: "trafodion/core"
      - check-build:
           dir: "trafodion/dcs"
      - pkg-install
#      no .gitignore in install
#      - check-build:
#           dir: "trafodion/install"
      - stage-traf:
           flavor: "{flavor}"
           btype: "$BUILD_TYPE"
           branch: "{branch}"

    publishers:
      - traf-upload-to-cdn
      - archive:
          artifacts: 'trafodion/install/install*.tar.gz'
          allow-empty: true
      - archive:
          artifacts: 'trafodion/dcs/target/dcs*.tar.gz'
          allow-empty: true
      - archive:
          artifacts: 'trafodion/core/trafodion-regress.tgz'
          allow-empty: true
      - archive:
          artifacts: 'trafodion/core/trafodion_clients*.tgz'
          allow-empty: true
      - archive:
          artifacts: 'trafodion/core/trafodion_server*.tgz'
          allow-empty: true
      - archive:
          artifacts: 'trafodion/core/rest/target/rest*.tar.gz'
          allow-empty: true
      - archive:
          artifacts: 'trafodion/distribution/*'
          allow-empty: true
      - console-log
      - git-log
      - traf-make-log

- job:
    name: 'build-label'
    node: 'traf_bld'

    parameters:
      - string:
          name: LOG_PATH
      - string:
          name: BUILD_TYPE
          default: ""
          description: "Blank for manual build; check, daily, pre-release, release"
      - string:
          name: BRANCH
          desription: "Branch tagged"
          default: "master"
      - string:
          name: TAG
          desription: "Git tag to build against"

    builders:
      - link-logs
      - clean-buildspace
      - single-git-label:
           repos: "apache/incubator-trafodion"
           label: "$TAG"
      - pkg-traf:
           flavor: "release"
      - pkg-install
      - stage-traf:
           flavor: "release"
           btype: "$BUILD_TYPE"
           branch: "$BRANCH"

    publishers:
      - traf-upload-to-cdn
      - console-log
      - git-log
      - traf-make-log


# Simple file type check can run on master
# Does not need to be exclusive

- job:
    name: 'static-checks'
    node: master

    parameters:
      - string:
          name: LOG_PATH

    builders:
      - link-logs
      - single-git-prep:
           repos: "apache/incubator-trafodion"
      - assert-no-binary-files:
           gitdir: "trafodion"
      - assert-no-bad-source-files:
           gitdir: "trafodion"

    publishers:
      - console-log
      - git-log
